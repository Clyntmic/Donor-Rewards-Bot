import { SlashCommandBuilder, EmbedBuilder, MessageFlags, ActionRowBuilder, ButtonBuilder, ButtonStyle } from "discord.js"
import { getDatabase } from "../utils/database.js"
import { logger } from "../utils/logger.js"

export const data = new SlashCommandBuilder()
  .setName("help")
  .setDescription("Show comprehensive help information")
  .addStringOption(option =>
    option.setName("type")
      .setDescription("Type of help to show")
      .addChoices(
        { name: "User Commands", value: "user" },
        { name: "Admin Commands", value: "admin" }
      )
      .setRequired(false)
  )

export async function execute(interaction) {
  try {
    const serverId = interaction.guildId
    const db = getDatabase(serverId)
    const helpType = interaction.options.getString("type")
    const isAdmin = await checkAdminPermissions(interaction, db)

    // If admin type requested but user is not admin
    if (helpType === "admin" && !isAdmin) {
      const embed = new EmbedBuilder()
        .setTitle("‚ùå Access Denied")
        .setDescription("You don't have permission to view admin commands.")
        .setColor("#ff0000")
      
      return await interaction.reply({ embeds: [embed], flags: MessageFlags.Ephemeral })
    }

    // Show specific help type if requested
    if (helpType === "admin") {
      return await showAdminHelp(interaction, db)
    } else if (helpType === "user") {
      return await showUserHelp(interaction, db, 0)
    }

    // Show main help menu with navigation
    await showMainHelp(interaction, db, isAdmin)
  } catch (error) {
    logger.error("Error in help command:", error)
    await interaction.reply({
      content: "‚ùå An error occurred while fetching help information.",
      flags: MessageFlags.Ephemeral,
    })
  }
}

async function showMainHelp(interaction, db, isAdmin) {
  const embed = new EmbedBuilder()
    .setTitle("üÜò Donor Rewards Bot - Help Center")
    .setDescription("**Welcome to the Donor Rewards Bot!**\n\nThis bot automatically tracks your donations and rewards you with draw entries, achievements, and special roles. Choose a category below to learn more.")
    .setColor(db.config?.theme?.info || "#00BCD4")

  embed.addFields(
    {
      name: "üöÄ Getting Started",
      value: [
        "1. **Donate** using tip.cc: `$tip @recipient amount SYMBOL`",
        "2. **Check draws** with `/draws list`",
        "3. **View your entries** with `/user entries`",
        "4. **Track progress** with `/user profile`",
        "5. **Earn achievements** by donating regularly!"
      ].join("\n"),
      inline: false
    },
    {
      name: "üìö Help Categories",
      value: [
        "üéØ **Essential Commands** - Core functionality",
        "üë§ **User Commands** - Profile, entries, achievements",
        "üéÅ **Draw System** - How draws work and entry tracking",
        "üèÜ **Achievements** - Unlock rewards by donating",
        "üé≠ **Donor Roles** - Special roles based on donation amounts"
      ].join("\n"),
      inline: false
    },
    {
      name: "üí° Quick Commands",
      value: [
        "`/donate` - Learn how to donate",
        "`/draws list` - See available draws",
        "`/user entries` - Check your entries",
        "`/user profile` - View your stats"
      ].join("\n"),
      inline: true
    },
    {
      name: "üîó Features",
      value: [
        "‚Ä¢ Real-time donation tracking",
        "‚Ä¢ Multiple draw participation",
        "‚Ä¢ Achievement system",
        "‚Ä¢ Privacy controls",
        "‚Ä¢ Leaderboards"
      ].join("\n"),
      inline: true
    }
  )

  const buttons = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
        .setCustomId("help_user_0")
        .setLabel("User Commands")
        .setStyle(ButtonStyle.Primary)
        .setEmoji("üë§"),
      new ButtonBuilder()
        .setCustomId("help_draws")
        .setLabel("Draw System")
        .setStyle(ButtonStyle.Secondary)
        .setEmoji("üéÅ"),
      new ButtonBuilder()
        .setCustomId("help_achievements")
        .setLabel("Achievements")
        .setStyle(ButtonStyle.Secondary)
        .setEmoji("üèÜ")
    )

  if (isAdmin) {
    buttons.addComponents(
      new ButtonBuilder()
        .setCustomId("help_admin")
        .setLabel("Admin Commands")
        .setStyle(ButtonStyle.Danger)
        .setEmoji("‚öôÔ∏è")
    )
  }

  embed.setFooter({ text: "Powered By Aegisum Eco System ‚Ä¢ Page 1/1" })
  
  const response = await interaction.reply({ 
    embeds: [embed], 
    components: [buttons], 
    flags: MessageFlags.Ephemeral 
  })

  // Set up button collector
  const collector = response.createMessageComponentCollector({ time: 300000 }) // 5 minutes

  collector.on('collect', async (buttonInteraction) => {
    if (buttonInteraction.user.id !== interaction.user.id) {
      return await buttonInteraction.reply({ 
        content: "‚ùå You can't use these buttons.", 
        flags: MessageFlags.Ephemeral 
      })
    }

    const [action, type, page] = buttonInteraction.customId.split('_')
    
    if (action === 'help') {
      switch (type) {
        case 'user':
          await showUserHelp(buttonInteraction, db, parseInt(page) || 0)
          break
        case 'admin':
          if (isAdmin) await showAdminHelp(buttonInteraction, db)
          break
        case 'draws':
          await showDrawHelp(buttonInteraction, db)
          break
        case 'achievements':
          await showAchievementHelp(buttonInteraction, db)
          break
        case 'back':
          await showMainHelp(buttonInteraction, db, isAdmin)
          break
      }
    }
  })

  collector.on('end', () => {
    // Disable buttons after timeout
    buttons.components.forEach(button => button.setDisabled(true))
    interaction.editReply({ components: [buttons] }).catch(() => {})
  })
}

async function showUserHelp(interaction, db, page = 0) {
  const userPages = [
    {
      title: "üë§ User Commands - Profile & Stats",
      description: "Commands to view and manage your donation profile and statistics.",
      fields: [
        {
          name: "/user profile [target]",
          value: "View detailed donation profile including total donated, achievements earned, and donation history. Add `target` to view another user's public profile.",
          inline: false
        },
        {
          name: "/user entries",
          value: "Check your current draw entries across all active draws. Shows how many entries you have in each draw and potential rewards.",
          inline: false
        },
        {
          name: "/user donor_roles",
          value: "View donor role requirements and your progress towards the next role. Shows all available donor roles and their donation thresholds.",
          inline: false
        },
        {
          name: "/user select_draw [draw_id]",
          value: "Choose which draw your future donations will count towards. Use `auto` to return to automatic selection based on donation amount.",
          inline: false
        }
      ]
    },
    {
      title: "üë§ User Commands - Achievements & Privacy",
      description: "Commands for achievements, privacy settings, and social features.",
      fields: [
        {
          name: "/user achievements [target]",
          value: "View your earned achievements and progress towards locked ones. Achievements are unlocked by donating, reaching milestones, and participating in draws.",
          inline: false
        },
        {
          name: "/user privacy <setting>",
          value: "Manage your privacy settings:\n‚Ä¢ `hide_profile` - Hide your profile from others\n‚Ä¢ `hide_donations` - Hide donation amounts\n‚Ä¢ `hide_achievements` - Hide achievement progress",
          inline: false
        },
        {
          name: "/user leaderboard [type]",
          value: "View leaderboards:\n‚Ä¢ `donations` - Top donors by amount\n‚Ä¢ `entries` - Most draw entries\n‚Ä¢ `achievements` - Most achievements earned",
          inline: false
        }
      ]
    }
  ]

  const currentPage = userPages[page] || userPages[0]
  const embed = new EmbedBuilder()
    .setTitle(currentPage.title)
    .setDescription(currentPage.description)
    .setColor(db.config?.theme?.info || "#00BCD4")

  currentPage.fields.forEach(field => embed.addFields(field))

  const buttons = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
        .setCustomId("help_back")
        .setLabel("‚Üê Back to Main")
        .setStyle(ButtonStyle.Secondary)
        .setEmoji("üè†")
    )

  if (page > 0) {
    buttons.addComponents(
      new ButtonBuilder()
        .setCustomId(`help_user_${page - 1}`)
        .setLabel("‚Üê Previous")
        .setStyle(ButtonStyle.Primary)
    )
  }

  if (page < userPages.length - 1) {
    buttons.addComponents(
      new ButtonBuilder()
        .setCustomId(`help_user_${page + 1}`)
        .setLabel("Next ‚Üí")
        .setStyle(ButtonStyle.Primary)
    )
  }

  embed.setFooter({ text: `Powered By Aegisum Eco System ‚Ä¢ Page ${page + 1}/${userPages.length}` })

  if (interaction.replied || interaction.deferred) {
    await interaction.editReply({ embeds: [embed], components: [buttons] })
  } else {
    await interaction.reply({ embeds: [embed], components: [buttons], flags: MessageFlags.Ephemeral })
  }
}

async function showAdminHelp(interaction, db) {
  const embed = new EmbedBuilder()
    .setTitle("‚öôÔ∏è Admin Commands - Management Tools")
    .setDescription("**Administrative commands for bot management and configuration.**\n\n‚ö†Ô∏è These commands require admin permissions.")
    .setColor("#ff6b6b")

  embed.addFields(
    {
      name: "üîß Setup & Configuration",
      value: [
        "`/admin setup` - Initial bot configuration wizard",
        "`/admin configure_donor_roles` - Set up donor role system",
        "`/admin features` - Toggle bot features on/off",
        "`/admin add_recipient` - Add allowed donation recipients",
        "`/admin remove_recipient` - Remove donation recipients"
      ].join("\n"),
      inline: false
    },
    {
      name: "üìä Monitoring & Analytics",
      value: [
        "`/admin dashboard` - View comprehensive admin dashboard",
        "`/admin analytics [type]` - Detailed analytics and statistics",
        "`/admin fix_achievements` - Fix achievement assignments",
        "`/admin clean_recipients` - Clean up recipient list"
      ].join("\n"),
      inline: false
    },
    {
      name: "üéÅ Draw Management",
      value: [
        "`/admin create_draw` - Create new donation draws",
        "`/admin edit_draw` - Modify existing draws",
        "`/admin select_winner <draw_id>` - Select draw winners",
        "`/admin assign_entries` - Manually assign draw entries"
      ].join("\n"),
      inline: false
    },
    {
      name: "üë• User Management",
      value: [
        "`/admin blacklist` - Manage blacklisted users",
        "`/admin reset_user` - Reset user data",
        "`/admin bulk_operations` - Perform bulk user operations"
      ].join("\n"),
      inline: false
    }
  )

  const buttons = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
        .setCustomId("help_back")
        .setLabel("‚Üê Back to Main")
        .setStyle(ButtonStyle.Secondary)
        .setEmoji("üè†")
    )

  embed.setFooter({ text: "Powered By Aegisum Eco System ‚Ä¢ Admin Help" })

  if (interaction.replied || interaction.deferred) {
    await interaction.editReply({ embeds: [embed], components: [buttons] })
  } else {
    await interaction.reply({ embeds: [embed], components: [buttons], flags: MessageFlags.Ephemeral })
  }
}

async function showDrawHelp(interaction, db) {
  const embed = new EmbedBuilder()
    .setTitle("üéÅ Draw System - How It Works")
    .setDescription("**Learn how the donation draw system works and how to participate.**")
    .setColor("#4CAF50")

  embed.addFields(
    {
      name: "üéØ How Draws Work",
      value: [
        "‚Ä¢ **Automatic Entry**: Donations automatically enter you into eligible draws",
        "‚Ä¢ **Entry Calculation**: Entries = Donation Amount √∑ Minimum Amount",
        "‚Ä¢ **Multiple Draws**: One donation can enter multiple draws",
        "‚Ä¢ **Fair System**: More donations = more entries = better chances"
      ].join("\n"),
      inline: false
    },
    {
      name: "üìã Draw Commands",
      value: [
        "`/draws list` - View all available draws with details",
        "`/draws info <draw_id>` - Get detailed information about a specific draw",
        "`/draws leaderboard <draw_id>` - See who has the most entries",
        "`/draws ids` - Quick reference for all draw IDs"
      ].join("\n"),
      inline: false
    },
    {
      name: "üéÆ Participation Tips",
      value: [
        "‚Ä¢ **Check Requirements**: Some draws have minimum amounts or VIP requirements",
        "‚Ä¢ **Select Draws**: Use `/user select_draw` to target specific draws",
        "‚Ä¢ **Track Progress**: Use `/user entries` to see your current entries",
        "‚Ä¢ **Stay Active**: Regular donations increase your chances"
      ].join("\n"),
      inline: false
    },
    {
      name: "üèÜ Draw Types",
      value: [
        "‚Ä¢ **Open Draws**: Anyone can participate",
        "‚Ä¢ **VIP Draws**: Require special VIP role",
        "‚Ä¢ **Minimum Amount**: Must donate at least the minimum",
        "‚Ä¢ **Limited Entries**: Some draws have maximum entry limits"
      ].join("\n"),
      inline: false
    }
  )

  const buttons = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
        .setCustomId("help_back")
        .setLabel("‚Üê Back to Main")
        .setStyle(ButtonStyle.Secondary)
        .setEmoji("üè†")
    )

  embed.setFooter({ text: "Powered By Aegisum Eco System ‚Ä¢ Draw System Guide" })

  if (interaction.replied || interaction.deferred) {
    await interaction.editReply({ embeds: [embed], components: [buttons] })
  } else {
    await interaction.reply({ embeds: [embed], components: [buttons], flags: MessageFlags.Ephemeral })
  }
}

async function showAchievementHelp(interaction, db) {
  const embed = new EmbedBuilder()
    .setTitle("üèÜ Achievement System - Unlock Rewards")
    .setDescription("**Earn achievements by donating and participating in the community.**")
    .setColor("#FFD700")

  embed.addFields(
    {
      name: "üéñÔ∏è Achievement Categories",
      value: [
        "‚Ä¢ **Donation Milestones**: Reach specific donation amounts",
        "‚Ä¢ **Participation**: Regular donation activity",
        "‚Ä¢ **Community**: Social engagement and referrals",
        "‚Ä¢ **Special Events**: Limited-time achievements"
      ].join("\n"),
      inline: false
    },
    {
      name: "üèÖ Available Achievements",
      value: [
        "ü•á **First Steps** - Make your first donation",
        "üí∞ **Generous Donor** - Donate $100 total",
        "üíé **Big Spender** - Donate $500 total",
        "üî• **Donation Streak** - Donate 7 days in a row",
        "üéØ **Lucky Winner** - Win a draw",
        "üë• **Community Builder** - Refer 5 users",
        "‚≠ê **VIP Status** - Reach VIP donor level"
      ].join("\n"),
      inline: false
    },
    {
      name: "üìä Achievement Commands",
      value: [
        "`/achievements list` - View all available achievements",
        "`/achievements view [achievement]` - Get details about specific achievement",
        "`/achievements progress` - See your progress towards locked achievements",
        "`/user achievements` - View your earned achievements"
      ].join("\n"),
      inline: false
    },
    {
      name: "üí° Tips for Earning",
      value: [
        "‚Ä¢ **Donate Regularly**: Many achievements require consistent activity",
        "‚Ä¢ **Increase Amounts**: Higher donations unlock milestone achievements",
        "‚Ä¢ **Stay Engaged**: Participate in community events",
        "‚Ä¢ **Refer Friends**: Earn referral-based achievements"
      ].join("\n"),
      inline: false
    }
  )

  const buttons = new ActionRowBuilder()
    .addComponents(
      new ButtonBuilder()
        .setCustomId("help_back")
        .setLabel("‚Üê Back to Main")
        .setStyle(ButtonStyle.Secondary)
        .setEmoji("üè†")
    )

  embed.setFooter({ text: "Powered By Aegisum Eco System ‚Ä¢ Achievement Guide" })

  if (interaction.replied || interaction.deferred) {
    await interaction.editReply({ embeds: [embed], components: [buttons] })
  } else {
    await interaction.reply({ embeds: [embed], components: [buttons], flags: MessageFlags.Ephemeral })
  }
}

async function checkAdminPermissions(interaction, db) {
  const OWNER_ID = process.env.OWNER_ID || "659745190382141453"
  if (interaction.user.id === OWNER_ID) return true
  if (!db.config?.adminRoleId) return false

  try {
    const member = await interaction.guild.members.fetch(interaction.user.id)
    return member.roles.cache.has(db.config.adminRoleId)
  } catch (error) {
    logger.error("Error checking admin permissions:", error)
    return false
  }
}
